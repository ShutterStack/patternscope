image: python:3.10

stages:
  - test
  - train
  - evaluate
  - check
  - deploy

variables:
  THRESHOLD_F1: "0.85"

before_script:
  - pip install -r requirements.txt

test:
  stage: test
  script:
    - echo "âœ… Running basic syntax checks..."
    - python -m py_compile src/*.py

train:
  stage: train
  script:
    - echo "ğŸš€ Training model..."
    - python src/train.py

evaluate:
  stage: evaluate
  script:
    - echo "ğŸ“Š Evaluating model..."
    - python src/evaluate.py

check:
  stage: check
  script:
    - |
      echo "ğŸ” Checking F1 threshold..."
      F1=$(cat logs/metrics.json | grep '"f1-score":' | head -n1 | awk '{print $2}' | tr -d ',')
      echo "F1-score: $F1"
      if [ $(echo "$F1 < $THRESHOLD_F1" | bc) -eq 1 ]; then
        echo "âŒ F1 below threshold! Failing pipeline."
        exit 1
      else
        echo "âœ… F1 above threshold."
      fi

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  before_script: []
  script:
    - echo "ğŸ³ Building and pushing image..."
    - export PROJECT_NAMESPACE_LOWER=$(echo "$CI_PROJECT_NAMESPACE" | tr '[:upper:]' '[:lower:]')
    - export PROJECT_NAME_LOWER=$(echo "$CI_PROJECT_NAME" | tr '[:upper:]' '[:lower:]')
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
    - docker build -t registry.gitlab.com/$PROJECT_NAMESPACE_LOWER/$PROJECT_NAME_LOWER:latest .
    - docker push registry.gitlab.com/$PROJECT_NAMESPACE_LOWER/$PROJECT_NAME_LOWER:latest

